
<html>
	<head>
		<style>
			#brawn_amount{
				background-color:#830300;
			}
			#intelligence_amount{
				background-color:#003366;
			}
			#agility_amount{
				background-color:#0D540D;
			}

		</style>
	</head>
	<body style="margin-left:0px; margin-right:0px; margin-top:0px; margin-bottom:0px; font-family:'my_font';">
		<div id="spectatorDiv">
			
				<span style="font-size:80px;"><center><b>DON'T GO ANYWHERE!</b></center></span>
				<span style="font-size:50px;"><center><div id="spectatorCountdownDiv">Next game starting in at most <b>200</b> seconds.</div></center></span>
				<span style="font-size:30px;"><i><center>most games end in much less time than the number above</center></i></span>
			
		</div>
		<div id="gameDiv">
			<canvas id="myCanvas" width="800" height="800"></canvas>
			<script>
				document.getElementById("myCanvas").width=window.innerWidth;
				document.getElementById("myCanvas").height=window.innerHeight;
			</script>
		</div>
		<div id="statsDiv">
			<center style="font-size:60px;"><b>THE ARENA</b><br>
			<div style="font-size:20px;">A multiplayer game - requires 2 or more players.</div>
			<div id="countdownDiv" style="font-size:80px;"></div><br>
			<span style="font-size:30px;">Choose your stats and username below:</span>
			
			<div id="pointsLeft">Skill points left: 6 points</div>
			
			<div id="statsContainer" style="font-size:30px; display:inline;">
				<h2><span color="830300"><b>Strength</b></span></h2>
				<h5>Increases health and damage</h5>
				<div style="margin-left:auto; width:400px; margin-right:auto;">
				<button onclick="updateLobbyClient('brawn', 'SUBTRACT');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">-</button> <div id="brawn_container" style="width:300px; height:30px; border:solid; border-width:2px; float:left;"> <div id="brawn_amount" style="width:0px; height:30px;"></div> </div> <button onclick="updateLobbyClient('brawn', 'ADD');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">+</button><br><br><br>
				</div>
				
				<h2><span color="003366">Resourcefulness</span></h2>
				<h5>Increases attack speed and makes food and water consumption more efficient</h5>
				<div style="margin-left:auto; width:400px; margin-right:auto;">
				<button onclick="updateLobbyClient('intelligence', 'SUBTRACT');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">-</button> <div id="intelligence_container" style="width:300px; height:30px; border:solid; border-width:2px; float:left;"> <div id="intelligence_amount" style="width:0px; height:30px;"></div> </div> <button onclick="updateLobbyClient('intelligence', 'ADD');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">+</button><br><br><br>
				</div>
				
				<h2><span color="0D540D">Agility</span></h2>
				<h5>Increases movement speed and stamina regeneration</h5>
				<div style="margin-left:auto; width:400px; margin-right:auto;">
				<button onclick="updateLobbyClient('agility', 'SUBTRACT');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">-</button> <div id="agility_container" style="width:300px; height:30px; border:solid; border-width:2px; float:left;"> <div id="agility_amount" style="width:0px; height:30px;"></div> </div> <button onclick="updateLobbyClient('agility', 'ADD');" style="background-color:#000000; color:#FFFFFF; width:30px; height:30px; border-radius:5px; float:left;">+</button><br><br><br>
				</div>
			</div>
			<div id="usernameContainer" style="font-size:50px;">
				Username: <input type="text" id="usernameTextbox" style="font-size:50px;"></input>
			</div>
			<br>
			<button id="submitButton" onclick="updateLobbyClient('', ''); submitStatData();" style="font-size:80px; border-radius:8px; background-color:#333333; color:#FFFFFF; font-family:'my_font';">Submit</button>
			</center>
		</div>
		<script src="/socket.io/socket.io.js"></script>
		<script>
		var socket = io();
		
		var c = document.getElementById("myCanvas");
		var ctx = c.getContext("2d");
		
		ctx.translate(window.innerWidth/2, window.innerHeight/2);
		ctx.scale(2, 2);
		ctx.translate(-window.innerWidth/2, -window.innerHeight/2);
		
		var my_socket_id;
		
		var grass = new Image();
		grass.src = 'http://104.236.222.45/DefHacksGame/images/grass.png';
		var tree = new Image();
		tree.src = 'http://104.236.222.45/DefHacksGame/images/tree.png';
		var rock = new Image();
		rock.src = 'http://104.236.222.45/DefHacksGame/images/rock.png';
		var stat_bar = new Image();
		stat_bar.src = 'http://104.236.222.45/DefHacksGame/images/stat_bar.png';
		var player_image = new Image();
		player_image.src = 'http://104.236.222.45/DefHacksGame/images/player.png';
		var dagger_icon = new Image();
		dagger_icon.src = 'http://104.236.222.45/DefHacksGame/images/dagger.png';
		var sword_icon = new Image();
		sword_icon.src = 'http://104.236.222.45/DefHacksGame/images/sword.png';
		var bow_icon = new Image();
		bow_icon.src = 'http://104.236.222.45/DefHacksGame/images/bow.png';
		var first_aid_icon = new Image();
		first_aid_icon.src = 'http://104.236.222.45/DefHacksGame/images/firstaid.png';
		var arrow_icon = new Image();
		arrow_icon.src = 'http://104.236.222.45/DefHacksGame/images/arrow.png';
		var item_holder_icon = new Image();
		item_holder_icon.src = 'http://104.236.222.45/DefHacksGame/images/itemholder.png';
		var bottle_empty = new Image();
		bottle_empty.src = 'http://104.236.222.45/DefHacksGame/images/canteen_empty.png';
		var bottle_full = new Image();
		bottle_full.src = 'http://104.236.222.45/DefHacksGame/images/canteen_full.png';
		var meat = new Image();
		meat.src = 'http://104.236.222.45/DefHacksGame/images/meat.png';
		var land_mine = new Image();
		land_mine.src = 'http://104.236.222.45/DefHacksGame/images/land_mine.png';
		var wolf = new Image();
		wolf.src = 'http://104.236.222.45/DefHacksGame/images/wolf.png';
		var pig = new Image();
		pig.src = 'http://104.236.222.45/DefHacksGame/images/pig.png';
		
		//handle stat choosing
		var brawn_points = 0;
		var intelligence_points = 0;
		var agility_points = 0;
		var points_to_spend = 6;
		var username = "";
		
		function updateLobbyClient(type, direction){
			if(direction == "ADD"){
				if(points_to_spend > 0){
					if(type == "brawn" && brawn_points < 4){
						brawn_points++;	
						points_to_spend--;
					}
					if(type == "intelligence" && intelligence_points < 4){
						intelligence_points++;
						points_to_spend--;
					}
					if(type == "agility" && agility_points < 4){
						agility_points++;
						points_to_spend--;
					}
				}
			}else{
				if(type == "brawn" && brawn_points > 0){
					brawn_points--;
					points_to_spend++;
				}
				if(type == "intelligence" && intelligence_points > 0){
					intelligence_points--;
					points_to_spend++;
				}
				if(type == "agility" && agility_points > 0){
					agility_points--;
					points_to_spend++;
				}
			
			}
			document.getElementById("pointsLeft").innerHTML = "Skill points left: " + points_to_spend + " points";
			document.getElementById("brawn_amount").style.width = ((brawn_points)*75) + "px";
			document.getElementById("intelligence_amount").style.width = ((intelligence_points)*75) + "px";
			document.getElementById("agility_amount").style.width = ((agility_points)*75) + "px";
			username = document.getElementById("usernameTextbox").value;
		}
		
		function submitStatData(){
			var data = [brawn_points, intelligence_points, agility_points, username];
			socket.emit('register_form', data);
			document.getElementById("submitButton").style.display = "none";
			submitted = true;
			alert("You have joined the game successfully!");
		}
		
		
		//send client keyboard and mouse state to server
		var mouse_X = 0;
		var mouse_Y = 0;
		var is_clicking = false;
		var rightkeydown = false;
		var leftkeydown = false;
		var upkeydown = false;
		var downkeydown = false;
		var shiftkeydown = false;
		var spacekeydown = false;
		var ekeydown = false;
		var enterkeydown = false;
		
		var onekeydown = false;
		var twokeydown = false;
		var threekeydown = false;
		var fourkeydown = false;
		var fivekeydown = false;
		var submitted = false;
		
		var isActivePlayer = false;
		var check_spectate_trigger;
		
		function sendData(){
			var data = [mouse_X, mouse_Y, is_clicking, rightkeydown, leftkeydown, upkeydown, downkeydown, shiftkeydown, spacekeydown, ekeydown, enterkeydown, onekeydown, twokeydown, threekeydown, fourkeydown, fivekeydown];
			socket.emit('user_input_state', data);

		}
		
		window.onmousemove = function(e){
			mouse_X = e.clientX;
			mouse_Y = e.clientY;
			sendData();
			
		}
		window.onmousedown = function(){
			is_clicking = true;
			sendData();
		}
		window.onmouseup = function(){
			is_clicking = false;
			sendData();
		}
		window.onkeydown = function(e){
			var key=e.keyCode ? e.keyCode : e.which;
			if (key===65) leftkeydown = true;
			if (key===68) rightkeydown = true;
			if (key===87) upkeydown = true;
			if (key===83) downkeydown = true;
			if (key===16) shiftkeydown = true;
			if (key===32) spacekeydown = true;
			if (key===69) ekeydown = true;
			if (key===13) enterkeydown = true;
			if (key===49) onekeydown = true;
			if (key===50) twokeydown = true;
			if (key===51) threekeydown = true;
			if (key===52) fourkeydown = true;
			if (key===53) fivekeydown = true;
			sendData();


		}
		window.onkeyup = function(e){
			var key=e.keyCode ? e.keyCode : e.which;
			if (key===65) leftkeydown = false;
			if (key===68) rightkeydown = false;
			if (key===87) upkeydown = false;
			if (key===83) downkeydown = false;
			if (key===16) shiftkeydown = false;
			if (key===32) spacekeydown = false;
			if (key===69) ekeydown = false;
			if (key===13) enterkeydown = false;
			if (key===49) onekeydown = false;
			if (key===50) twokeydown = false;
			if (key===51) threekeydown = false;
			if (key===52) fourkeydown = false;
			if (key===53) fivekeydown = false;
			sendData();
		}

		window.onresize = function(e){
			document.getElementById("myCanvas").width=window.innerWidth;
			document.getElementById("myCanvas").height=window.innerHeight;
		}
	

		//other code
		var cameraX = 0;
		var cameraY = 0;
		
		function clear(){
			ctx.clearRect(0, 0, c.width, c.height);
			ctx.fillStyle = "#000000";
			ctx.fillRect(0, 0, c.width, c.height);
		}
		
		socket.on('your_socket_id', function(socket_id){
			my_socket_id = socket_id;
		});
		
		socket.on('basic_data', function(data){
			if(data.stage == "STATS"){
				document.getElementById("gameDiv").style.display = "none";
				document.getElementById("statsDiv").style.display = "block";
				document.getElementById("spectatorDiv").style.display = "none";
				document.getElementById("countdownDiv").innerHTML = data.countdown;
				if(!submitted){
					document.getElementById("submitButton").style.display = "block";
				}
			}
			if(data.stage == "GAMEPLAY"){
				console.log("YOU ARE IN THE GAME");
				submitted = false;
				document.getElementById("statsDiv").style.display = "none";
				if(isActivePlayer){
					document.getElementById("spectatorDiv").style.display = "none";
					document.getElementById("gameDiv").style.display = "block";
				}else{
					document.getElementById("spectatorDiv").style.display = "block";
					var timeLeft = Math.round(Math.sqrt((data.map_radius-50)/20)*25) - 100;
					if(timeLeft > 0){
						document.getElementById("spectatorCountdownDiv").innerHTML = "Next game starting in <u>at most</u> <b>" + timeLeft + "</b> seconds.";
					}else{
						document.getElementById("spectatorCountdownDiv").innerHTML = "Game starting VERY soon...";
					}
					
					document.getElementById("gameDiv").style.display = "none";
				}
			}
		});
		
		
		socket.on('all_game_data', function(data){
			if(data.stage == "GAMEPLAY"){
				isActivePlayer = true;
				clearInterval(check_spectate_trigger);
				check_spectate_trigger = setTimeout(function(){isActivePlayer = false;}, 2000); //changes to specator mode if no frames recieved for 2 seconds
				
				var window_dime = [window.innerWidth, window.innerHeight];
				socket.emit('window_size_data', window_dime);
				
				clear();
				
				
				console.log(data.edges);
				
				for(var i = 0; i < data.players.length; i++){
					if(typeof data.players[i] !== 'undefined'){
						if(data.players[i].socket_id == my_socket_id){
							cameraX = data.players[i].xPos-window.innerWidth/2;
							cameraY = data.players[i].yPos-window.innerHeight/2;
							
						}
					}
				}

				for(var i = -2; i < (window.innerWidth/40)+1; i++){
					for(var j = -2; j < (window.innerHeight/40)+1; j++){
						var drawX = i*40 - (cameraX % 40);
						var drawY = j*40 - (cameraY % 40);
						var mapDrawCenterX = data.map_center_x - cameraX;
						var mapDrawCenterY = data.map_center_y - cameraY;
						var deltaX = drawX - mapDrawCenterX;
						var deltaY = drawY - mapDrawCenterY;
						

						if(Math.sqrt((deltaX*deltaX) + (deltaY*deltaY)) < data.map_radius + 12){
							ctx.drawImage(grass, drawX, drawY);
						}
						
					}
				}
				
				for(var i = 0; i < data.obstacles.length; i++){
					if(data.obstacles[i].type == "TREE"){
						ctx.drawImage(tree, data.obstacles[i].xPos - cameraX - 20,data.obstacles[i].yPos- cameraY - 20);
					}else{
						ctx.drawImage(rock, data.obstacles[i].xPos - cameraX,data.obstacles[i].yPos- cameraY);
					}
				}
				
				for(var i = 0; i < data.items.length; i++){
					if(data.items[i].type == "dagger"){
						ctx.drawImage(dagger_icon, data.items[i].xPos - cameraX,data.items[i].yPos- cameraY);
					}
					if(data.items[i].type == "sword"){
						ctx.drawImage(sword_icon, data.items[i].xPos - cameraX,data.items[i].yPos- cameraY);
					}
					if(data.items[i].type == "arrows"){
						ctx.drawImage(arrow_icon, data.items[i].xPos - cameraX,data.items[i].yPos- cameraY);
					}
					if(data.items[i].type == "firstaid"){
						ctx.drawImage(first_aid_icon, data.items[i].xPos - cameraX,data.items[i].yPos- cameraY);
					}
					if(data.items[i].type == "empty_bottle"){
						ctx.drawImage(bottle_empty, data.items[i].xPos - cameraX,data.items[i].yPos- cameraY);
					}
					if(data.items[i].type == "full_bottle"){
						ctx.drawImage(bottle_full, data.items[i].xPos - cameraX,data.items[i].yPos - cameraY);
					}
					if(data.items[i].type == "meat"){
						ctx.drawImage(meat, data.items[i].xPos - cameraX,data.items[i].yPos - cameraY);
					}
					if(data.items[i].type == "land_mine"){
						ctx.drawImage(land_mine, data.items[i].xPos - cameraX,data.items[i].yPos - cameraY);
					}
				}
				
				for(var i = 0; i < data.creatures.length; i++){
					if(typeof data.creatures[j] !== 'undefined'){
					if(data.creatures[i].type == "WOLF"){
						ctx.drawImage(wolf, data.creatures[i].xPos - cameraX, data.creatures[i].yPos - cameraY);
					}else if(data.creatures[i].type == "PIG"){
						ctx.drawImage(pig, data.creatures[i].xPos - cameraX, data.creatures[i].yPos - cameraY);
					}
					
					ctx.fillStyle = "#000000";
					ctx.fillRect(data.creatures[i].xPos - cameraX - 31, data.creatures[i].yPos - cameraY - 11, 102, 7);
					
					ctx.fillStyle = "#FF0000";
					ctx.fillRect(data.creatures[i].xPos - cameraX - 30, data.creatures[i].yPos - cameraY - 10, (data.creatures[i].health/data.creatures[i].max_health)*100, 5);
					}
				}
				ctx.beginPath();
				ctx.arc(data.map_center_x - cameraX, data.map_center_y - cameraY, data.map_radius, 0, 2*Math.PI);
				ctx.stroke();
				ctx.arc(data.map_center_x - cameraX, data.map_center_y - cameraY, data.map_radius+50, 0, 2*Math.PI);
				ctx.stroke();
				
				for(var i = 0; i < data.players.length; i++){
					if(typeof data.players[i] !== 'undefined'){
						if(data.players[i].socket_id == my_socket_id){
							ctx.fillStyle = "#000000";
							ctx.fillRect(5+(window.innerWidth*0.75) - 225 * 0.75, 10 + window.innerHeight*0.25, 150, 21);
							
							ctx.fillStyle = "#FF0000";
							ctx.fillRect(5+(window.innerWidth*0.75) - 225 * 0.75 + 1, 11 + window.innerHeight*0.25, 148*(data.players[i].health/data.players[i].max_health), 19);
							
							ctx.fillStyle = "#000000";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75 + 75, 35 + window.innerHeight*0.25, 75, 14);
							
							ctx.fillStyle = "#0000FF";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75 + 75 + 1, 36 + window.innerHeight*0.25, 73*(data.players[i].stamina/data.players[i].max_stamina), 12);
							
							ctx.fillStyle = "#000000";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75, 65 + window.innerHeight*0.25, 150, 14);
							
							ctx.fillStyle = "#888800";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75 + 1, 66 + window.innerHeight*0.25, 148*(data.players[i].hunger/100), 12);
							
							ctx.fillStyle = "#000000";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75, 85 + window.innerHeight*0.25, 150, 14);
							
							ctx.fillStyle = "#33FF55";
							ctx.fillRect(5+ (window.innerWidth*0.75) - 225 * 0.75 + 1, 86 + window.innerHeight*0.25, 148*(data.players[i].thirst/100), 12);
							
							ctx.translate(c.width/2+20, c.height/2+20);
							ctx.rotate(data.players[i].aimDirection+2.356*0.8+data.players[i].attackAnimationStep/100);
							if(data.players[i].inventory[data.players[i].inventoryFocusIndex] == "dagger"){
								ctx.drawImage(dagger_icon, -40, -40);
							}
							if(data.players[i].inventory[data.players[i].inventoryFocusIndex] == "sword"){
								ctx.drawImage(sword_icon, -40, -40);
							}
							ctx.rotate(-data.players[i].aimDirection-2.356*0.8-data.players[i].attackAnimationStep/100);
							ctx.translate(-c.width/2-20, -c.height/2-20);
							
							ctx.fillStyle = "#000000";
							ctx.fillRect(5+(window.innerWidth*0.75) - 100 * 0.75 - 2, 130+window.innerHeight*0.25+data.players[i].inventoryFocusIndex*50 - 2, 44, 44);
							
							for(var j = 0; j < 5; j++){
								ctx.drawImage(item_holder_icon, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								if(data.players[i].inventory[j] == "dagger"){
									ctx.drawImage(dagger_icon, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}
								if(data.players[i].inventory[j] == "sword"){
									ctx.drawImage(sword_icon, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}
								if(data.players[i].inventory[j] == "firstaid"){
									ctx.drawImage(first_aid_icon, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}
								if(data.players[i].inventory[j] == "empty_bottle"){
									ctx.drawImage(bottle_empty, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}
								if(data.players[i].inventory[j] == "full_bottle"){
									ctx.drawImage(bottle_full, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}
								if(data.players[i].inventory[j] == "meat"){
									ctx.drawImage(meat, 5+(window.innerWidth*0.75) - 100 * 0.75, 130+window.innerHeight*0.25+j*50);
								}	
							}
							
						}
					}
				}
				
				for(var i = 0; i < data.players.length; i++){
					ctx.drawImage(player_image, data.players[i].xPos - cameraX, data.players[i].yPos - cameraY);
					
					ctx.fillStyle = "#000000";
					ctx.fillRect(data.players[i].xPos - cameraX - 31, data.players[i].yPos - cameraY - 11, 102, 7);
					
					ctx.fillStyle = "#FF0000";
					ctx.fillRect(data.players[i].xPos - cameraX - 30, data.players[i].yPos - cameraY - 10, (data.players[i].health/data.players[i].max_health)*100, 5);
				} 		
			}else if(data.stage == "END"){
				brawn_points = 0;
				intelligence_points = 0;
				agility_points = 0;
				points_to_spend = 6;
			}
		});
		
		socket.on('game_over', function(winner){
			ctx.font="60px Georgia";
			ctx.fillStyle="#000000";
			ctx.fillText(winner + " won!", window.innerWidth/2-20*0.8*8, window.innerHeight/2-80);
		});
		
		socket.on('not_enough', function(){
			alert("Not enough players to join! The Arena is a multiplayer game! (you need 2 or more)");
			document.getElementById("submitButton").style.display = "block";
			brawn_points = 0;
			intelligence_points = 0;
			agility_points = 0;
			points_to_spend = 6;
		});
		
		

		
		//all client side visualization code goes over here :)
		</script>
	</body>
</html>
